<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel CRUD Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #b2dfdb, #80cbc4);
            font-family: 'Segoe UI', sans-serif;
            padding: 2rem;
        }
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        td.editable:hover {
            background-color: #e0f7fa;
            cursor: pointer;
        }
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Excel CRUD Dashboard</h2>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addModal">+ Add New</button>
            <button class="btn btn-outline-primary" id="backupBtn">‚¨áÔ∏è Export Backup</button>
        </div>
    </div>

    <div class="input-group mb-3">
        <span class="input-group-text">üîç</span>
        <input type="text" id="searchInput" class="form-control" placeholder="Search records...">
    </div>

    <div class="table-container">
        <table class="table table-striped" id="dataTable">
            <thead class="table-light">
                <tr id="tableHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <nav>
            <ul class="pagination" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Modal for Adding New -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addModalLabel">Add New Record</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addForm" class="row g-3"></form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="submitAdd">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const PAGE_SIZE = 50;
let allData = [];
let headers = [];
let currentPage = 1;

async function loadData() {
    const res = await fetch('/api/data');
    const data = await res.json();
    allData = data;
    headers = Object.keys(data[0] || {});
    buildTable();
    buildAddForm();
}

function buildTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allData.filter(row =>
        Object.values(row).some(val => String(val).toLowerCase().includes(search))
    );
    const start = (currentPage - 1) * PAGE_SIZE;
    const pageData = filtered.slice(start, start + PAGE_SIZE);

    const headerRow = document.getElementById('tableHeader');
    headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('') + '<th>Actions</th>';

    const body = document.getElementById('tableBody');
    body.innerHTML = '';
    pageData.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
            const td = document.createElement('td');
            td.textContent = row[h];
            td.classList.add('editable');
            td.dataset.key = h;
            td.dataset.index = start + rowIndex;
            td.addEventListener('click', handleEditCell);
            tr.appendChild(td);
        });
        const actionTd = document.createElement('td');
        actionTd.innerHTML = `<button class="btn btn-sm btn-danger" onclick="deleteRow(${start + rowIndex})">üóëÔ∏è</button>`;
        tr.appendChild(actionTd);
        body.appendChild(tr);
    });
    buildPagination(filtered.length);
}

function buildPagination(total) {
    const totalPages = Math.ceil(total / PAGE_SIZE);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = () => { currentPage = i; buildTable(); };
        pagination.appendChild(li);
    }
}

function buildAddForm() {
    const form = document.getElementById('addForm');
    form.innerHTML = headers.map(h => `
        <div class="col-md-6">
            <label class="form-label">${h}</label>
            <input type="text" class="form-control" name="${h}">
        </div>`).join('');
}

document.getElementById('submitAdd').addEventListener('click', async (e) => {
    e.preventDefault();
    const form = document.getElementById('addForm');
    const formData = Object.fromEntries(new FormData(form).entries());
    const res = await fetch('/api/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    });
    if (res.ok) {
        alert('Record added');
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        await loadData();
    }
});

async function handleEditCell(e) {
    const td = e.target;
    const original = td.textContent;
    const input = document.createElement('input');
    input.value = original;
    input.className = 'form-control form-control-sm';
    td.textContent = '';
    td.appendChild(input);
    input.focus();
    input.onblur = async () => {
        const newValue = input.value;
        td.textContent = newValue;
        if (newValue !== original) {
            const idx = td.dataset.index;
            const key = td.dataset.key;
            allData[idx][key] = newValue;
            await fetch('/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(allData[idx])
            });
        }
    };
}

async function deleteRow(index) {
    if (!confirm('Delete this record?')) return;
    const res = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(allData[index])
    });
    if (res.ok) {
        alert('Record deleted');
        await loadData();
    }
}

document.getElementById('backupBtn').addEventListener('click', () => {
    window.location.href = '/api/backup';
});

document.getElementById('searchInput').addEventListener('input', () => {
    currentPage = 1;
    buildTable();
});

loadData();
</script>
</body>
</html>
