name: Auto Push Index
on:
  workflow_dispatch:

jobs:
  push-and-pr:
    runs-on: ubuntu-latest
    env:
      # branch will be unique per run to avoid stale/non-fast-forward errors
      BRANCH_PREFIX: feature/ui-add-delay-legend-move
      COMMIT_MSG: "feat(ui): add delay after add submission, update data-view heading, move code legend under add form"
      PR_TITLE: "UI: delay after add, update data-view heading, move code legend under add-new form"
      PR_BODY: |
        Summary:
        - Adds a short delay (3s) before switching to Data View after a successful Add New Entry submission.
        - Updates the Data View heading.
        - Moves the Code Legend under the Add New form.
    steps:
      - name: Checkout main (no persisted credentials)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Build unique branch name
        run: |
          # Use github.run_id to guarantee uniqueness per workflow run
          echo "BRANCH=${BRANCH_PREFIX}-${{ github.run_id }}" >> $GITHUB_ENV

      - name: Validate PAT (do not print it)
        env:
          PAT: ${{ secrets.GH_PUSH_PAT }}
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $PAT" https://api.github.com/user)
          echo "status=$status"
          if [ "$status" != "200" ]; then
            echo "PAT validation failed (HTTP $status). Ensure the PAT has 'repo' scope and is authorized for the organization."
            exit 1
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"

      - name: Create branch from main
        run: |
          git checkout -b "$BRANCH"

      - name: Ensure index.html is present
        run: |
          if [ -f .github/prepared/index.html ]; then
            echo "Using .github/prepared/index.html"
            cp .github/prepared/index.html ./index.html
          else
            echo ".github/prepared/index.html not found, expecting index.html to exist in repo root"
          fi
          if [ ! -f index.html ]; then
            echo "ERROR: index.html not found in workspace. Put your prepared file at .github/prepared/index.html or at repo root index.html."
            exit 1
          fi
          echo "index.html size: $(wc -c < index.html) bytes"

      - name: Commit and push branch using PAT (non-interactive, unique branch)
        env:
          GIT_AUTH_TOKEN: ${{ secrets.GH_PUSH_PAT }}
        run: |
          git add index.html
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"

          # Add a PAT-authenticated remote (temporary for this push)
          git remote remove origin || true
          git remote add origin "https://x-access-token:${GIT_AUTH_TOKEN}@github.com/${{ github.repository }}.git"

          # Prevent interactive prompts and ensure no credential helper intercepts
          export GIT_TERMINAL_PROMPT=0

          # Push the uniquely-named branch (no force needed)
          git push origin "$BRANCH" --set-upstream

      - id: create_pr
        name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PUSH_PAT }}
          base: main
          head: ${{ env.BRANCH }}
          title: ${{ env.PR_TITLE }}
          body: ${{ env.PR_BODY }}

      - name: Show PR URL
        run: |
          echo "PR URL: ${{ steps.create_pr.outputs.pull-request-url }}"
